<!DOCTYPE html>
<html>
<head>
<link rel=stylesheet href="zilla-slab.css">
<title>
  Recent and future evolution of the Web Audio API (again)
</title>
<meta charset="utf-8">
<style>
body {
  font-family: "Zilla Slab";
}


blink {
    -webkit-animation: 1s linear infinite condemned_blink_effect; // for android
    animation: 1s linear infinite condemned_blink_effect;
}
@-webkit-keyframes condemned_blink_effect { // for android
    0% {
            visibility: hidden;
        }
    50% {
            visibility: hidden;
        }
    100% {
            visibility: visible;
        }
}
@keyframes condemned_blink_effect {
    0% {
            visibility: hidden;
        }
    50% {
            visibility: hidden;
        }
    100% {
            visibility: visible;
        }
}

h1, .logo {
  font-family: "Zilla Slab Highlight";
  font-weight: 700;
}
iframe {
  width: 100%;
  height: 600px;
}

@font-face{
    font-family: 'Fira Code';
    src: url('FiraCode-Regular.woff2') format('woff2'),
    font-weight: 400;
    font-style: normal;
}

.remark-code, .remark-inline-code {
  font-family: 'Fira Code';
}

a, a:visited {
  color: black;
  text-decoration: none;
  border-bottom: 1px dashed black;
  font-family: "Fira Code";
}

dt {
  font-weight: 700;
  line-height: 2em;
}

dd {
  border-left: 5px solid black;
  padding-left: 10px;
}

.bigger {
  font-size: 1.5em;
}

.big {
  font-size: 2em;
}

</style>
</head>
<body>
<textarea id="source">

  class: center, middle

  # Recent and future evolution of the Web Audio API

  Paul Adenot

  <span class="big logo">mozilla</span>

  Web Audio Conference 2018

  TU Berlin

  ---

  class: middle

  ```sh
  $ git clone git@github.com:padenot/wac-17-slides.git wac-18-slides
  $ cd wac-18-slides
  $ sed -i "s/17/18/" index.html
  $ sed -i "s/London/Berlin/" index.html
  ```

  ---

  # Agenda

  ## What's new in the spec since WAC'17?
  ## Where are we in the standardization process?
  ## What's coming up (more exciting this time around)?

  ---

  class: middle center

  # Some statistics: pull requests

  <img src="merged.png" style="max-width:80%">

  ---

  class: middle center

  # Some statistics: issues

  <img src="closed.png" style="max-width:80%">

  ---

  class: middle

  # Contributor count

  ```sh
  $ git log --color --since=2017-08-23
  | grep "Author:" | sort | uniq | wc -l
  19
  ```

  - BBC, Google, Intel, Dolby, Opera, Microsoft, Mozilla, Noteflight, W3C, etc.
  - Universities, public research lab
  - Independant people

  ---

  class: center middle

  # Changes to the spec

  ---

  class: center middle

  # Changes to the <blink style="color:red">spec</blink>

  ---

  # However

  Tests are happening, lots of tests from Chromium, some from Mozilla, and then
  some other.

  - <a href="https://wpt.fyi/results/webaudio">https://wpt.fyi/results/webaudio</a>
  - <a href="https://treeherder.mozilla.org/#/jobs?repo=mozilla-central">https://treeherder.mozilla.org/#/jobs?repo=mozilla-central</a>
  - Also running on Chromium's CI

  Reasonably encouraging Web Compat results

  ---

  # AudioWorklet - related changes

  ---

  # OfflineAudioContext lazy allocation

  - The allocation is only done when `startRendering()` is called
  - A failure to allocate is signaled by a rejected `Promise`

  ---

  # MediaElementAudio SourceNode behaviour

  - Once "captured", can't undo it
  - On `AudioContext.{close, suspend}`, audio frames are dropped (not auto
  paused/no auto routed to the speakers again)
  - `HTMLMediaElement.captureStream()` exists, is more flexible

  ---

  # PannerNode .set{Orientation,Position} and ctor can now throw

  - (Reminder) Equivalent to:

  ```
  {PannerNode,AudioListener}.{position,orientation}.{X,Y,Z}.value = v;
  ```

  - Throws is if a `setValueCurveAtTime` event exists at `currentTime`
  - The ctor checks for values outside valid values, and can now throw
  - `refDistance` can now be 0

  ---

  # AnalyserNode memory footprint

  - Changing `fftSize` should not introduce discontinuities
  - This means that the node should always keep 32768 sample-frames
  around for each `AnalyserNode`.

  ---

  # Cycles with AudioParam, AudioListener

  - `AudioParam` have a transitive precedence relation with their `AudioNode`
  - `AudioListener` is an implicit input of all the `PannerNode`s
  - This allows the quasi-topological sort to yield the correct order, and to
  have minimal delay in cycles

  ---

  # Editorial

  - Now use [bikeshed](https://github.com/tabatkins/bikeshed) instead of [ReSpec](https://github.com/w3c/respec)
      - Faster spec loading
      - More cross-referencing capabilities
      - Algorithms validation
      - Generaly more ergonomic
  - Auto-publishing and tests via [travis-ci](https://travis-ci.org/WebAudio/web-audio-api)
  - [Diff](https://pr-preview.s3.amazonaws.com/WebAudio/web-audio-api/1737/c05ff33...rtoy:10a9cfb.html#Convolution-channel-configurations) and [preview](https://pr-preview.s3.amazonaws.com/rtoy/web-audio-api/pull/1737.html) in PRs
  - [Changelog](https://webaudio.github.io/web-audio-api/#changelog) (required for CR)
  - IP validation for any non-trivial PR

  ---

  # AudioContextOptions

  - Can specify settings like so:

  ```js

  var ac = new AudioContext({ latencyHint: "playback",
                              sampleRate: 16000 });

  ```

  - By default
      - `"interactive"` (low-latency) audio output
      - sample-rate rate of the default audio output device sample-rate
      - beware of 192kHz sound card, üí∏üí∏üí∏.

  ---

  # AudioBufferSourceNode precise definition

  Very precisely specced now

  - [Looping](https://webaudio.github.io/web-audio-api/#looping-AudioBufferSourceNode)
  - [Playback](https://webaudio.github.io/web-audio-api/#playback-AudioBufferSourceNode)

  Start and stop are subsample-accurate, looping as well. Specced with an
  algorithm (more precise than english), with lots of (non-normative) diagrams
  to explain.

  ---

  # AudioParam rates

  - `AudioParam.automationRate` : `a-rate` | `k-rate`
  - A few restrictions
      - `AudioBufferSourceNode.{playbackRate,detune}`, always `"k-rate"`
      - `DynamicsCompressorNode.{threshold, knee, ratio, attack, release}`, always `"k-rate"`
      - `PannerNode`, `AudioListener` `AudioParam`s, always `"k-rate"` if HRTF,
      selectable otherwise.
      - `BiquadFilterNode` params are now `a-rate` (allows audio rate modulation
      of filter cutoff, etc.)
      - `k-rate` often _much_ cheaper in terms of CPU

  ---

  # AudioBuffer clarifications

  - `new AudioBuffer` can throw: OOM (by policy or because of hardware
     constraints)
  - `copyFromChannel` and `copyToChannel` can throw as well

  ---

  # OscillatorNode detune nominal range

  Reminder: silent clipping of `AudioParam`s to nominal range _during
  processing_.

  Now ¬±1200 ‚ãÖ log<sub>2</sub>`FLT_MAX` (around ¬±153600), prevents overflows and
  NaNs, etc.

  ---

  # Closed BaseAudioContext

  Does not throw error anymore. In fact nothing throws when a context is
  closed, things just don't happen.

  ---

  # AudioParam insertion rules

  In a few words:

  - It's allowed to schedule a ramp that ends on a curve.
  - It's allowed to schedule something exactly at the end of the curve
  - It's not allowed to schedule something that starts or end in a curve
  - We're trying to make it so that time are _not_ clamped w.r.t `currentTime`

  ---

  # Suspend/resume early return

  - Now the promise is going to do the full round-trip every time
  - Makes reasonning simpler

  ---

  # AudioWorklet changes

  - Numerous
  - Output arrays are zero-initialized
  - `outputChannel` now works in the ctor (mono by default)
  - `AudioParam` `ArrayBuffer` with constant value during this render quantum
     can have a length of 1
  - Return value
  - `processorOptions` dictionary
  - `currentFrame` in Worklet Global Scope
  - Event loop clarifications

  ---

  # The big GC observability issue

  XXX 

  ---

  # Security and privacy consideration section

  Required for CR

  Analysis of various fingerprinting vectors:

  - Hardware characteristics: max channel count, sample-rate (can be spoofed)
  - Clock skew between system time and audio time
  - Latency figures, depends on the hardware and software
  - Ultrasonic communication channel
  - System sound masquerading

  ---

  # V.NEXT

  - Audio encoding/decoding consolidation
  - In memory compressed audio asssets
  - `SharedArrayBuffer` + `AudioWorklet` + `wasm` = ‚ù§Ô∏è
  - `AudioContext` in Web Worker
  - Configurable `AudioParam` rate
  - Custom HRTF
  - Pulse/noise oscillator
  - Expose x-runs
  - Oscillator phase offset as an audioparam
  - Frequency domain nodes 
  - Side chain compression
  - Expander/noise-gain

  ---

  class: center,middle

  # QUESTIONS ?

  ---

  # Thanks !

  <dl>
    <dt>
      Slides
    </dt>
    <dd>
      <a
        href="https://padenot.github.io/wac-18-slides">https://padenot.github.io/wac-18-slides</a><br>
      <a
        href="https://github.com/padenot/wac-18-slides">https://github.com/padenot/wac-18-slides</a>
    </dd>
    <dt>
      Editor's draft of the specification
    </dt>
    <dd>
    <a href="https://webaudio.github.io/web-audio-api">https://webaudio.github.io/web-audio-api</a>
    </dd>
    <dt>
      Specification issue tracker
    </dt>
    <dd>
     <a
       href="https://github.com/webaudio/web-audio-api/issues/">https://github.com/webaudio/web-audio-api/issues/</a>
    </dd>
    <dt>Contribute to tests (running on all implementations)</dt>
    <dd>
      <a href="https://github.com/w3c/web-platform-tests/">
        https://github.com/w3c/web-platform-tests/
      </a>
    </dd>
    <dt>Email</dt>
    <dd><a
      href="mailto:padenot@mozilla.com"><code>padenot@mozilla.com</code></a></dd>
    <dt>Twitter</dt>
    <dd><a href="https://twitter.com/padenot">@padenot</a></dd>
  </dl>

</textarea>
<script src="remark-latest.min.js">
</script>
<script>
var slideshow = remark.create();
</script>
</body>
<style>
.remark-slide-content {
    font-size: 28px;
}
</style>
</html>
